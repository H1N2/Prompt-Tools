# Prompt Tools 详细设计文档

## 1. 前端详细设计

### 1.1 界面组件设计

#### 1.1.1 PromptCard 组件
**功能**: 展示单个提示词信息
**结构**:
```html
<div class="prompt-card" data-id="{id}">
  <div class="pin-indicator" v-if="pinned">📌</div>
  <div class="card-header">
    <h3 class="card-title">{name}</h3>
    <div class="card-actions">
      <button class="btn-pin">置顶</button>
      <button class="btn-copy">复制</button>
      <button class="btn-edit">编辑</button>
      <button class="btn-delete">删除</button>
    </div>
  </div>
  <div class="card-meta">来源、时间等信息</div>
  <div class="card-tags">标签列表</div>
  <div class="card-content">内容预览</div>
</div>
```

**交互行为**:
- 悬停显示操作按钮
- 点击打开详情页
- 支持键盘导航

#### 1.1.2 SearchBar 组件
**功能**: 搜索和筛选
**特性**:
- 实时搜索（300ms防抖）
- 标签筛选
- 来源筛选
- 快捷键支持

#### 1.1.3 Modal 组件
**类型**:
- 创建/编辑模态框
- 详情查看模态框
- 确认对话框

**交互**:
- ESC键关闭
- 点击遮罩关闭
- 表单验证

### 1.2 状态管理

```typescript
interface AppState {
  prompts: Prompt[];
  filteredPrompts: Prompt[];
  isLoading: boolean;
  currentView: 'grid' | 'list';
  currentTheme: 'light' | 'dark';
  searchQuery: string;
  selectedTags: string[];
  selectedSources: string[];
}
```

### 1.3 事件系统

```typescript
// 事件类型
interface Events {
  'prompt:created': { prompt: Prompt };
  'prompt:updated': { prompt: Prompt };
  'prompt:deleted': { id: number };
  'search:changed': { query: string };
}

// 键盘快捷键
const shortcuts = {
  'ctrl+n': () => createPrompt(),
  'ctrl+f': () => focusSearch(),
  'ctrl+s': () => savePrompt(),
  'escape': () => closeModal()
};
```

## 2. 后端API设计

### 2.1 数据模型

#### 2.1.1 核心结构
```rust
#[derive(Serialize, Deserialize)]
pub struct Prompt {
    pub id: i64,
    pub name: String,
    pub source: Option<String>,
    pub notes: Option<String>,
    pub tags: Vec<String>,
    pub pinned: bool,
    pub content: String,
    pub version: String,
    pub created_at: String,
    pub updated_at: String,
    pub current_version_id: Option<i64>,
}

#[derive(Serialize, Deserialize)]
pub struct Version {
    pub id: i64,
    pub prompt_id: i64,
    pub version: String,
    pub content: String,
    pub created_at: String,
    pub parent_version_id: Option<i64>,
}
```

#### 2.1.2 请求/响应结构
```rust
pub struct CreatePromptRequest {
    pub name: String,
    pub source: Option<String>,
    pub notes: Option<String>,
    pub tags: Vec<String>,
    pub content: String,
}

pub struct SearchResult {
    pub prompts: Vec<Prompt>,
    pub total: usize,
    pub tags: Vec<String>,
    pub sources: Vec<String>,
}
```

### 2.2 API命令

#### 2.2.1 基础操作
- `get_all_prompts()` - 获取所有提示词
- `create_prompt(req)` - 创建提示词
- `update_prompt(id, req)` - 更新提示词
- `delete_prompt(id)` - 删除提示词
- `toggle_pin(id)` - 切换置顶状态

#### 2.2.2 搜索功能
- `search_prompts(query, tags, sources)` - 搜索提示词
- `get_all_tags()` - 获取所有标签
- `get_all_sources()` - 获取所有来源
- `get_category_counts()` - 获取分类统计

#### 2.2.3 版本管理
- `get_prompt_versions(prompt_id)` - 获取版本历史
- `rollback_to_version(prompt_id, version_id, type)` - 版本回滚

#### 2.2.4 数据管理
- `export_data()` - 导出数据
- `export_data_to_file(path)` - 导出到文件
- `import_data(data)` - 导入数据

### 2.3 数据库设计

#### 2.3.1 表结构
```sql
-- 提示词表
CREATE TABLE prompts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    source TEXT,
    notes TEXT,
    tags TEXT, -- JSON格式
    pinned INTEGER DEFAULT 0,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    current_version_id INTEGER
);

-- 版本表
CREATE TABLE versions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    prompt_id INTEGER NOT NULL,
    version TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at TEXT NOT NULL,
    parent_version_id INTEGER,
    FOREIGN KEY(prompt_id) REFERENCES prompts(id) ON DELETE CASCADE
);

-- 设置表
CREATE TABLE settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL
);
```

#### 2.3.2 索引优化
```sql
CREATE INDEX idx_prompts_updated_at ON prompts(updated_at);
CREATE INDEX idx_versions_prompt_id ON versions(prompt_id);
```

### 2.4 错误处理

```rust
#[derive(Debug, thiserror::Error)]
pub enum AppError {
    #[error("数据库错误: {0}")]
    Database(#[from] rusqlite::Error),
    #[error("验证错误: {message}")]
    Validation { message: String },
    #[error("未找到资源: {resource}")]
    NotFound { resource: String },
}
```

## 3. 用户交互流程

### 3.1 核心操作流程

#### 3.1.1 创建提示词
1. 用户点击"创建"按钮
2. 打开创建模态框
3. 用户填写表单
4. 前端验证数据
5. 调用后端API
6. 后端验证并保存
7. 返回结果并更新UI

#### 3.1.2 搜索流程
1. 用户输入搜索关键词
2. 防抖处理(300ms)
3. 调用搜索API
4. 返回搜索结果
5. 更新显示列表

#### 3.1.3 版本管理
1. 用户查看版本历史
2. 选择目标版本
3. 确认回滚操作
4. 创建新版本
5. 更新当前版本

### 3.2 响应式设计

#### 3.2.1 断点系统
- 小屏幕 (< 768px): 单列布局
- 中等屏幕 (768px - 1024px): 双列布局
- 大屏幕 (> 1024px): 三列布局

#### 3.2.2 自适应特性
- 侧边栏可折叠
- 卡片大小自适应
- 字体缩放支持

## 4. 性能优化

### 4.1 前端优化
- **虚拟滚动**: 大数据列表优化
- **防抖搜索**: 减少API调用
- **组件缓存**: 重复组件复用
- **懒加载**: 按需加载内容

### 4.2 后端优化
- **数据库索引**: 查询性能优化
- **连接复用**: 数据库连接管理
- **批量操作**: 减少数据库访问
- **内存管理**: Rust零成本抽象

### 4.3 存储优化
- **增量更新**: 只更新变更部分
- **压缩存储**: JSON数据压缩
- **清理机制**: 自动清理旧版本
- **备份策略**: 定期数据备份

## 5. 安全设计

### 5.1 数据安全
- **本地存储**: 数据不上传云端
- **输入验证**: 防止恶意数据
- **SQL注入防护**: 参数化查询
- **文件权限**: 适当的访问控制

### 5.2 应用安全
- **CSP策略**: 内容安全策略
- **权限最小化**: 最小系统权限
- **代码签名**: 应用完整性验证
- **依赖安全**: 安全的第三方库

## 6. 测试策略

### 6.1 单元测试
- 数据库操作测试
- API命令测试
- 工具函数测试
- 组件功能测试

### 6.2 集成测试
- 前后端集成测试
- 数据库迁移测试
- 导入导出测试
- 跨平台兼容测试

### 6.3 用户测试
- 功能完整性测试
- 用户体验测试
- 性能压力测试
- 错误恢复测试

## 7. 部署和发布

### 7.1 构建流程
1. 前端TypeScript编译
2. 后端Rust编译
3. Tauri应用打包
4. 平台适配
5. 代码签名
6. 安装包生成

### 7.2 发布渠道
- GitHub Releases
- 官方网站下载
- 未来考虑应用商店

### 7.3 更新机制
- 手动下载更新
- 未来支持自动更新
- 版本兼容检查
- 数据迁移支持

## 8. 总结

该详细设计文档涵盖了Prompt Tools的前端界面设计、后端API设计、数据库结构、用户交互流程、性能优化、安全策略等关键方面。设计遵循现代Web应用的最佳实践，确保应用的可用性、性能和安全性。

主要特点：
1. **模块化设计**: 清晰的组件分离和职责划分
2. **类型安全**: TypeScript和Rust提供的类型保证
3. **性能优先**: 多层面的性能优化策略
4. **安全第一**: 本地优先和隐私保护设计
5. **用户友好**: 直观的交互设计和响应式布局

该设计为项目的实施提供了详细的技术规范和实现指导。