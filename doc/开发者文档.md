# Prompt Tools 开发者文档

## 📋 目录
1. [环境搭建](#1-环境搭建)
2. [项目结构](#2-项目结构)
3. [开发指南](#3-开发指南)
4. [代码规范](#4-代码规范)
5. [测试和构建](#5-测试和构建)
6. [贡献指南](#6-贡献指南)

## 1. 环境搭建

### 1.1 前置要求
- **Node.js**: v18+ 
- **pnpm**: 8.0+
- **Rust**: 1.70+
- **Git**: 最新版本

### 1.2 Tauri 环境配置

**macOS**:
```bash
xcode-select --install
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

**Windows** (计划支持):
```bash
# 安装 Visual Studio C++ Build Tools
# 安装 WebView2 Runtime
```

### 1.3 项目安装
```bash
# 克隆项目
git clone https://github.com/jwangkun/Prompt-Tools.git
cd Prompt-Tools

# 安装依赖
pnpm install

# 启动开发环境
pnpm tauri:dev
```

### 1.4 IDE 配置
推荐使用 **VS Code** 并安装以下扩展：
- rust-lang.rust-analyzer
- tauri-apps.tauri-vscode
- ms-vscode.vscode-typescript-next

## 2. 项目结构

```
Prompt-Tools/
├── src/                    # 前端源代码
│   ├── main.ts            # 主应用逻辑
│   ├── advanced.ts        # 高级功能模块
│   └── styles.css         # 全局样式
├── src-tauri/             # Tauri 后端
│   ├── src/
│   │   ├── main.rs        # 应用入口
│   │   ├── lib.rs         # API 命令
│   │   └── database.rs    # 数据库操作
│   ├── Cargo.toml         # Rust 依赖
│   └── tauri.conf.json    # Tauri 配置
├── doc/                   # 项目文档
├── package.json           # 前端配置
├── tsconfig.json          # TypeScript 配置
└── vite.config.ts         # 构建配置
```

### 2.1 核心模块
- **前端**: TypeScript + Vite + 原生DOM
- **后端**: Rust + Tauri + SQLite
- **UI**: CSS3 变量 + 响应式设计

## 3. 开发指南

### 3.1 启动开发
```bash
# 开发模式（热重载）
pnpm tauri:dev

# 仅前端开发
pnpm dev

# 类型检查
pnpm typecheck
```

### 3.2 前端开发

#### 3.2.1 添加新功能
```typescript
// 示例：创建新组件
function createNewComponent(data: ComponentData): HTMLElement {
  const element = document.createElement('div');
  element.className = 'new-component';
  element.innerHTML = `
    <h3>${data.title}</h3>
    <p>${data.content}</p>
  `;
  return element;
}

// 调用后端 API
async function callBackendAPI() {
  try {
    const result = await invoke('api_command', { param: 'value' });
    console.log('成功:', result);
  } catch (error) {
    console.error('失败:', error);
    showNotification('操作失败', 'error');
  }
}
```

#### 3.2.2 状态管理
```typescript
// 全局状态
interface AppState {
  prompts: Prompt[];
  isLoading: boolean;
  currentTheme: 'light' | 'dark';
}

let appState: AppState = {
  prompts: [],
  isLoading: false,
  currentTheme: 'light'
};
```

### 3.3 后端开发

#### 3.3.1 添加新API命令
```rust
// 1. 在 lib.rs 中定义命令
#[tauri::command]
async fn new_api_command(
    app_handle: tauri::AppHandle,
    param: String
) -> Result<String, String> {
    let app_dir = app_handle.path().app_data_dir()
        .map_err(|e| format!("路径错误: {}", e))?;
    
    let db_path = app_dir.join("prompts.db");
    let db = Database::new(db_path)
        .map_err(|e| format!("数据库错误: {}", e))?;
    
    // 业务逻辑
    let result = db.some_operation(&param)
        .map_err(|e| format!("操作失败: {}", e))?;
    
    Ok(result)
}

// 2. 注册命令
.invoke_handler(tauri::generate_handler![
    new_api_command,
    // 其他命令...
])
```

#### 3.3.2 数据库操作
```rust
// 在 database.rs 中添加方法
impl Database {
    pub fn some_operation(&self, param: &str) -> SqliteResult<String> {
        let mut stmt = self.conn.prepare(
            "SELECT column FROM table WHERE condition = ?1"
        )?;
        
        let result: String = stmt.query_row([param], |row| {
            Ok(row.get(0)?)
        })?;
        
        Ok(result)
    }
}
```

### 3.4 调试技巧

#### 3.4.1 前端调试
```typescript
// 开发环境日志
if (import.meta.env.DEV) {
  console.log('调试:', data);
}

// 在 Tauri 应用中按 F12 打开开发者工具
```

#### 3.4.2 后端调试
```rust
// 控制台输出
println!("调试信息: {:?}", variable);
eprintln!("错误信息: {}", error);

// 条件编译
#[cfg(debug_assertions)]
println!("仅调试模式输出");
```

## 4. 代码规范

### 4.1 TypeScript 规范

#### 4.1.1 命名约定
```typescript
// 变量和函数：camelCase
const userName = 'john';
function getUserData() {}

// 常量：SCREAMING_SNAKE_CASE
const API_BASE_URL = 'http://localhost';

// 类型和接口：PascalCase
interface UserData {
  id: number;
  name: string;
}
```

#### 4.1.2 类型定义
```typescript
// 优先使用 interface
interface Prompt {
  id: number;
  name: string;
  content: string;
  tags: string[];
}

// 联合类型
type Theme = 'light' | 'dark';
type Status = 'loading' | 'success' | 'error';
```

### 4.2 Rust 规范

#### 4.2.1 命名约定
```rust
// 变量和函数：snake_case
let user_name = "john";
fn get_user_data() {}

// 常量：SCREAMING_SNAKE_CASE
const API_BASE_URL: &str = "http://localhost";

// 结构体：PascalCase
struct UserData {
    id: i64,
    name: String,
}
```

#### 4.2.2 错误处理
```rust
// 使用 Result 类型
pub fn create_item(data: ItemData) -> Result<i64, AppError> {
    validate_data(&data)?;
    let id = database.insert(data)?;
    Ok(id)
}

// 自定义错误
#[derive(Debug, thiserror::Error)]
pub enum AppError {
    #[error("数据库错误: {0}")]
    Database(#[from] rusqlite::Error),
    #[error("验证错误: {message}")]
    Validation { message: String },
}
```

### 4.3 CSS 规范

#### 4.3.1 BEM 命名
```css
/* Block */
.prompt-card {}

/* Element */
.prompt-card__header {}
.prompt-card__content {}

/* Modifier */
.prompt-card--pinned {}
.prompt-card--selected {}
```

#### 4.3.2 CSS 变量
```css
:root {
  /* 颜色 */
  --primary-color: #3b82f6;
  --secondary-color: #6b7280;
  
  /* 间距 */
  --space-sm: 0.5rem;
  --space-md: 1rem;
  --space-lg: 1.5rem;
  
  /* 字体 */
  --font-size-sm: 0.875rem;
  --font-size-base: 1rem;
}
```

### 4.4 Git 提交规范

#### 4.4.1 提交格式
```
<type>(<scope>): <description>

[optional body]
[optional footer]
```

**类型**:
- `feat`: 新功能
- `fix`: 修复
- `docs`: 文档
- `style`: 格式
- `refactor`: 重构
- `test`: 测试

**示例**:
```
feat(ui): 添加深色主题支持

- 实现主题切换功能
- 添加深色模式样式
- 保存用户主题偏好

Closes #42
```

## 5. 测试和构建

### 5.1 测试

#### 5.1.1 前端测试
```bash
# 安装测试依赖
pnpm add -D vitest jsdom @testing-library/dom

# 运行测试
pnpm test

# 监视模式
pnpm test --watch
```

#### 5.1.2 后端测试
```rust
// 单元测试示例
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_create_prompt() {
        let db = Database::new(":memory:").unwrap();
        let req = CreatePromptRequest {
            name: "Test".to_string(),
            content: "Content".to_string(),
            tags: vec!["test".to_string()],
            source: None,
            notes: None,
        };
        
        let id = db.create_prompt(req).unwrap();
        assert!(id > 0);
    }
}
```

```bash
# 运行 Rust 测试
cargo test

# 显示输出
cargo test -- --nocapture
```

### 5.2 构建

#### 5.2.1 开发构建
```bash
# 前端构建
pnpm build

# 类型检查
pnpm typecheck

# Rust 检查
cargo check
```

#### 5.2.2 生产构建
```bash
# 完整构建
pnpm tauri:build

# 构建产物位置：
# macOS: src-tauri/target/release/bundle/macos/
# Windows: src-tauri/target/release/bundle/msi/
# Linux: src-tauri/target/release/bundle/deb/
```

### 5.3 发布流程

#### 5.3.1 版本管理
```bash
# 更新版本
pnpm version patch   # 0.1.0 -> 0.1.1
pnpm version minor   # 0.1.1 -> 0.2.0
pnpm version major   # 0.2.0 -> 1.0.0

# 手动同步 src-tauri/Cargo.toml 版本号
```

#### 5.3.2 发布步骤
1. 更新版本号
2. 更新 CHANGELOG.md
3. 运行所有测试
4. 构建应用
5. 创建 Git 标签
6. 发布 GitHub Release

## 6. 贡献指南

### 6.1 贡献流程

#### 6.1.1 Fork 和开发
```bash
# 1. Fork 项目
# 2. Clone 你的 fork
git clone https://github.com/YOUR_USERNAME/Prompt-Tools.git

# 3. 添加上游仓库
git remote add upstream https://github.com/jwangkun/Prompt-Tools.git

# 4. 创建功能分支
git checkout -b feature/your-feature

# 5. 开发和提交
git add .
git commit -m "feat: 添加新功能"

# 6. 推送和创建 PR
git push origin feature/your-feature
```

### 6.2 贡献要求

#### 6.2.1 代码质量
- [ ] 遵循代码规范
- [ ] 添加必要测试
- [ ] 通过所有测试
- [ ] 更新相关文档

#### 6.2.2 PR 要求
- [ ] 清晰的 PR 描述
- [ ] 关联相关 Issue
- [ ] 包含测试截图（UI 改动）
- [ ] 响应代码审查

### 6.3 社区规范
- 尊重所有贡献者
- 保持建设性讨论
- 欢迎新手参与
- 及时回应问题

### 6.4 问题报告
使用 GitHub Issues 报告：
- **Bug**: 问题描述、复现步骤、期望行为
- **功能请求**: 需求描述、使用场景、实现建议
- **问题讨论**: 技术讨论、设计决策

## 7. 常见问题

### 7.1 开发问题

#### Q: Tauri 开发模式启动失败？
```bash
# 解决方案
rustup update stable
cargo clean && pnpm clean
pnpm install
```

#### Q: TypeScript 类型错误？
```bash
# 解决方案
pnpm typecheck
rm -rf node_modules dist
pnpm install
```

### 7.2 构建问题

#### Q: 构建失败？
```bash
# 检查详细日志
pnpm tauri:build --verbose

# 清理重建
cargo clean
rm -rf dist
pnpm install && pnpm tauri:build
```

### 7.3 性能调优

#### 7.3.1 前端优化
- 使用浏览器开发者工具分析性能
- 检查内存使用情况
- 优化大列表渲染（虚拟滚动）

#### 7.3.2 后端优化
- 使用 `cargo flamegraph` 分析性能
- 优化数据库查询
- 减少不必要的内存分配

---

## 📞 获取帮助

- **GitHub Issues**: [报告问题或建议](https://github.com/jwangkun/Prompt-Tools/issues)
- **文档**: 查看项目 README 和文档
- **社区**: 参与 GitHub Discussions

感谢您对 Prompt Tools 的贡献！